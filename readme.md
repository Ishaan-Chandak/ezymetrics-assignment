# EzyMetrics API Documentation

This document provides an overview of the EzyMetrics API, including its structure, functionalities, and how to use it effectively.

## Table of Contents

1. [Introduction](#introduction)
2. [Project Structure](#project-structure)
3. [Database Models](#database-models)
   - [Lead Model](#lead-model)
   - [Campaign Model](#campaign-model)
4. [API Endpoints](#api-endpoints)
   - [Fetch Leads](#fetch-leads)
   - [Fetch Campaigns](#fetch-campaigns)
   - [Load Data to MongoDB](#load-data-to-mongodb)
   - [Generate CSV Report](#generate-csv-report)
5. [Metrics Calculation](#metrics-calculation)
6. [PDF Generation](#pdf-generation)
7. [Email Notification](#email-notification)
8. [Setup and Installation](#setup-and-installation)

## Introduction

EzyMetrics is a web application designed to manage and analyze leads and campaigns. It utilizes a RESTful API to perform operations like fetching leads, campaigns, and generating reports. The application uses MongoDB as the database and includes features for data loading, metrics calculation, PDF report generation, and email notifications.

## Project Structure

```
EzyMetrics/
├── models/
│ ├── Lead.js
│ └── Campaign.js
├── reports/
│ ├── metrics.js
│ ├── pdf.js
├── mail/
│ └── email.js
├── data/
│ ├── leads.json
│ └── campaigns.json
├── server.js
└── package.json
```

## Database Models

### Lead Model

The `Lead` model represents a lead in the application. It includes fields such as:

- `leadId`: Unique identifier for the lead.
- `firstName`, `lastName`, `email`, `phone`: Personal details of the lead.
- `status`: Current status of the lead (e.g., Interested, Qualified, Closed).
- `createdAt`: Timestamp when the lead was created.
- `source`: The source through which the lead was generated.
- `assignedTo`: Sales representative assigned to the lead.
- `company`: Company name associated with the lead.
- `leadScore`: Score indicating the quality of the lead.
- `salesRep`: The sales representative's name.
- `closedAt`: Timestamp when the lead was closed.

**Lead Schema Code:**

```javascript
const mongoose = require("mongoose");

const leadSchema = new mongoose.Schema({
  leadId: { type: String, required: true, unique: true },
  firstName: { type: String, required: true },
  lastName: { type: String, required: true },
  email: { type: String, required: true, match: /.+\@.+\..+/ },
  phone: { type: String, required: true },
  status: {
    type: String,
    enum: ["Interested", "Contacted", "Qualified", "Closed", "Lost"],
    required: true,
  },
  createdAt: { type: Date, required: true, default: Date.now },
  source: { type: String, required: true },
  assignedTo: { type: String, required: true },
  company: { type: String, required: true },
  leadScore: { type: Number, required: true },
  salesRep: { type: String, required: true },
  closedAt: { type: Date },
});

const Lead = mongoose.model("Lead", leadSchema);
module.exports = Lead;
```

### Campaign Model

The `Campaign` model represents a marketing campaign and includes fields such as:

- `campaignId`: Unique identifier for the campaign.
- `name`: Name of the campaign.
- `type`: Type of campaign (e.g., Email, Social Media).
- `startDate`, `endDate`: Dates defining the campaign duration.
- `budget`: Budget allocated for the campaign.
- `leadsGenerated`: Number of leads generated by the campaign.
- `status`: Current status of the campaign (e.g., Ongoing, Completed).
- `createdBy`: User who created the campaign.
- `channel`: Channel used for the campaign.
- `performance`: Performance rating of the campaign.
- `conversionRate`: Rate of conversions from the campaign.

**Campaign Schema Code:**

```javascript
const mongoose = require("mongoose");

const campaignSchema = new mongoose.Schema({
  campaignId: { type: String, required: true, unique: true },
  name: { type: String, required: true },
  type: {
    type: String,
    enum: ["Email", "Social Media", "Event", "PPC"],
    required: true,
  },
  startDate: { type: Date, required: true },
  endDate: { type: Date, required: true },
  budget: { type: Number, required: true },
  leadsGenerated: { type: Number, required: true, default: 0 },
  status: {
    type: String,
    enum: ["Ongoing", "Completed", "Planned"],
    required: true,
  },
  createdBy: { type: String, required: true },
  channel: { type: String, required: true },
  performance: {
    type: String,
    enum: ["Excellent", "High", "Moderate", "N/A"],
    required: true,
  },
  conversionRate: { type: Number, required: true, default: 0.0 },
});

const Campaign = mongoose.model("Campaign", campaignSchema);
module.exports = Campaign;
```

## API Endpoints

### Fetch Leads

**GET** `/api/leads`

This endpoint retrieves all leads from the `leads.json` file and returns them as JSON.

**Example Response:**

```json
[
  {
    "leadId": "1",
    "firstName": "John",
    "lastName": "Doe",
    ...
  }
]
```

### Fetch Campaigns

**GET** `/api/campaigns`

This endpoint retrieves all campaigns from the `campaigns.json` file and returns them as JSON.

**Example Response:**

```json
[
  {
    "campaignId": "1",
    "name": "Summer Sale",
    "type": "Email",
    ...
  }
]
```

### Load Data to MongoDB

**GET** `/api/load-data`

This endpoint loads leads and campaigns from JSON files into the MongoDB database. It first clears the existing data and then inserts the new data.

**Example Response:**

```
Data loaded successfully
```

### Generate CSV Report

**GET** `/api/report/csv`

This endpoint generates a CSV report containing various metrics related to leads and campaigns. It calculates metrics such as lead conversion rate, lead-to-opportunity ratio, and churn rate, then sends the report as a CSV file.

**Example Response:**

```
Content-Type: text/csv
Attachment: report.csv
```

## Metrics Calculation

Metrics are calculated in the `metrics.js` file. The following metrics are implemented:

1. **Lead Conversion Rate**: Percentage of leads converted to closed status.
2. **Lead-to-Opportunity Ratio**: Ratio of qualified leads to total leads.
3. **Leads Assigned per Sales Rep**: Count of leads assigned to each sales representative.
4. **Lead Closure Time**: Time taken to close qualified leads.
5. **Pipeline Health**: Percentage of leads in the pipeline.
6. **Lead Acquisition Cost**: Cost to acquire a lead based on campaign budget.
7. **Top 5 High-Value Leads**: The top five leads based on lead score.
8. **Lead Churn Rate**: Percentage of leads marked as lost.
9. **Total Leads in Every Campaign**: Total leads generated across campaigns.

## PDF Generation

The `pdf.js` file contains functionality to generate PDF reports. The `generatePDFReport` function creates a PDF document with the report data.

**PDF Generation Code:**

```javascript
const PDFDocument = require("pdfkit");
const fs = require("fs");

const generatePDFReport = (reportData) => {
  const doc = new PDFDocument();
  const writeStream = fs.createWriteStream("report.pdf");
  doc.pipe(writeStream);
  doc.fontSize(25).text("EzyMetrics Report", { align: "center" });
  doc.moveDown();

  reportData.forEach((item) => {
    doc.fontSize(12).text(`${item.Metric}: ${item.Value}`);
    doc.moveDown();
  });

  doc.end();

  return new Promise((resolve) => {
    writeStream.on("finish", () => {
      resolve();
    });
  });
};

module.exports = { generatePDFReport };
```

## Email Notification

The `email.js` file provides functionality for sending email notifications using Nodemailer. It uses an SMTP transporter to send emails to the specified recipient.

**Email Notification Code:**

```javascript
const nodemailer = require("nodemailer");

const transporter = nodemailer.createTransport({
  host: "smtp.ethereal.email",
  port: 587,
  auth: {
    user: "your-email@example.com",
    pass: "your-email-password",
  },
});

const sendEmailNotification = async (recipient, subject, text) => {
  try {
    const info = await transporter.sendMail({
      from: '"Lead Notification" <your-email@example.com>',
      to: recipient,
      subject: subject,
      text: text,
    });

    console.log("Message sent: %s", info.messageId);
    return true;
  } catch (error) {
    console.error("Error sending email:", error);
    return false;
  }
};

module.exports = { sendEmailNotification };
```

## Setup and Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/your-repo/ezyMetrics.git
   cd ezyMetrics
   ```
2. Install dependencies:
   ```bash
   npm install
   ```
3. Start the server:
   ```bash
   node server.js
   ```
4. Access the API at `http://localhost:3000/api`.

## Conclusion

This documentation provides a detailed overview of the EzyMetrics API, its functionalities, and how to use it effectively. Feel free to explore and modify the code according to your requirements.

### Additional Notes

- Make sure to replace placeholder values with actual data (like email credentials) in the code snippets.
- You can add diagrams or charts for visual representation, especially for metrics and data flow.
- Include sample JSON data for leads and campaigns in the documentation for better clarity.

Let me know if you need any further modifications or additions!
